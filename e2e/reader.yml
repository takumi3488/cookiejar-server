desc: Readerサービス E2Eテスト (gRPC)
runners:
  req: http://localhost:3000
  greq:
    addr: localhost:50051
    tls: false

vars:
  testHost: example.com
  testHost2: test.com
  nonExistentHost: nonexistent.com

steps:
  # データ準備: example.comのCookieを保存
  prepareTestData:
    loop:
      count: 20
      until: 'steps.prepareTestData.res.status == 200'
      minInterval: 1
      maxInterval: 30
      multiplier: 1.5
    desc: テストデータを準備（example.comのCookie）
    req:
      /:
        post:
          body:
            application/json:
              - name: test_cookie
                value: test_value
                domain: example.com
                path: /
    test: |
      current.res.status == 200

  # データ準備: test.comのCookieを保存
  prepareTestData2:
    desc: テストデータを準備（test.comのCookie）
    req:
      /:
        post:
          body:
            application/json:
              - name: test_cookie2
                value: test_value2
                domain: test.com
                path: /
    test: |
      current.res.status == 200

  # テスト1: ホスト別Cookie取得（事前にデータが必要）
  getCookiesForHost:
    desc: example.comのCookieを取得
    greq:
      /proto.v1.CookieService/GetCookies:
        message:
          host: example.com
    test: |
      current.res.status == 0
      && current.res.message.cookies != null

  # テスト2: 別ホストのCookie取得
  getCookiesForHost2:
    desc: test.comのCookieを取得
    greq:
      /proto.v1.CookieService/GetCookies:
        message:
          host: test.com
    test: |
      current.res.status == 0
      && current.res.message.cookies != null

  # テスト3: 存在しないホストのCookie取得（NOT_FOUNDを返す）
  getCookiesForNonExistentHost:
    desc: 存在しないホストのCookieを取得
    greq:
      /proto.v1.CookieService/GetCookies:
        message:
          host: nonexistent.com
    test: |
      current.res.status == 5  // gRPC NOT_FOUNDステータスコード

  # テスト4: 空のホストパラメータ
  getCookiesEmptyHost:
    desc: 空のホストでCookieを取得
    greq:
      /proto.v1.CookieService/GetCookies:
        message:
          host: ""
    test: |
      current.res.status == 5  // gRPC NOT_FOUNDステータスコード
